<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{basic.html}">
<head>
    <meta charset="UTF-8">
</head>
<body>

<div layout:fragment="content">

    <!-- Breadcrumb Section Begin -->
    <section class="breadcrumb-section set-bg" data-setbg="/img/strawberry3.jpg">
        <div class="container">
            <div class="row">
                <div class="col-lg-12 text-center">
                    <div class="breadcrumb__text">
                        <h2>공지사항 게시판</h2>
                        <div class="breadcrumb__option">
                            <a href="/basic">Home</a>
                            <a href="/notice/list">Notice List</a>
                            <span>Notice View</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- Breadcrumb Section End -->


    <div class="contact-form spad">
        <div class="container">

            <form action="/notice/delete" method="post" id="frm_delete">
                <input type="hidden" name="idx" th:value="${boardDTO.idx}">

                <div class="row">
                    <div class="col-lg-12 col-md-12">
                        <input type="text" readonly  id="title" name="title" th:value="${boardDTO.title}" style="border: 0px; border-bottom: 1px solid #ebebeb;">
                    </div>

                    <div class="col-lg-6 col-md-6">
                        <label class="mx-3">작성자 : <input type="text" readonly  id="memberId" name="memberId" th:value="${boardDTO.memberId}" style="width:fit-content; border: 0px; border-bottom: 1px solid #ebebeb;"></label>
                    </div>

                    <div class="col-lg-6 col-md-6">
                        <label>등록일 : <input type="text" readonly  id="regDate" name="regDate" th:value="${boardDTO.regDate}" style="width:fit-content; border: 0px; border-bottom: 1px solid #ebebeb;"></label>
                    </div>

                    <div class="col-lg-12 mx-3 overflow-auto" style="max-height: 500px;" th:utext="${boardDTO.content}">
                    </div>



                    <div th:if="${boardDTO.orgFileName != null and !#strings.toString(boardDTO.orgFileName).equals('') and !#strings.toString(boardDTO.orgFileName).isEmpty()}" class="col-lg-12 mx-3 mt-4" >
                        <label>파일 : </label>
                        <span><a th:href="|@{/notice/download(idx=${boardDTO.idx})}|" target="_blank">[[${boardDTO.orgFileName}]]</a></span>
                        <!--                        <a download th:href="@{/uploads/board/${boardDTO.orgFileName}}">파일 다운로드</a>-->
                        <!--                        <div>[[${boardDTO.orgFileName}]]</div>-->
                    </div>


                    <div class="col-lg-12 d-flex justify-content-between mt-5" >

                        <div>
                            <button type="button" class="btn btn-outline-danger mx-2" onclick="delete_notice()" th:if="${session.memberId == boardDTO.memberId}">삭제</button>
                            <script>
                                const frm = document.querySelector("frm_delete");
                                function delete_notice() {
                                    let chk_del = confirm("정말 삭제하시겠습니까?");
                                    if(chk_del) {
                                        frm_delete.submit();
                                    }
                                }
                            </script>
                        </div>

                        <div>
                            <a th:href='@{/notice/modify(idx=${boardDTO.idx})}' th:if="${session.memberId == boardDTO.memberId}" >
                                <button type="button" class="btn btn-success mx-2" >수정하기</button>
                            </a>
                            <button type="button" class="btn btn-secondary" onclick="location.href='/notice/list'">목록</button>
                        </div>
                    </div>

                </div>
            </form>


            <!--            ===================== 댓글 리스트 영역 start =====================-->

            <h5 class="my-3 mt-5">댓글 리스트</h5>
            <div class="border-top replyList">

            </div>

            <div class="row mt-3">
                <div class="col">
                    <ul class="pagination replyPaging justify-content-center">

                    </ul>
                </div>
            </div>

            <!--            ===================== 댓글 리스트 영역 end =====================-->


        </div>
    </div>


    <!--    <div class="row mt-3">-->
    <!--        <div class="col-md-12">-->
    <!--            <div class="my-4">-->
    <!--                <button class="btn btn-info registReplyBtn">댓글 등록</button>-->
    <!--            </div>-->
    <!--            <ul class="list-group replyList">-->

    <!--            </ul>-->
    <!--        </div>-->
    <!--    </div>-->

    <!--    <div class="row mt-3">-->
    <!--        <div class="col">-->
    <!--            <ul class="pagination replyPaging">-->

    <!--            </ul>-->
    <!--        </div>-->
    <!--    </div>-->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="/static/js/replyBoard.js"></script>
</div>

<script layout:fragment="script" th:inline="javascript">
    const idx = [[${boardDTO.idx}]];
    const replyList = document.querySelector(".replyList");
    const replyPaging = document.querySelector(".replyPaging");

    function printReplyArea(page, page_size, goLast) {  //비동기 통신으로 갖고와
        getReplyList({idx, page, page_size, goLast})
            .then(
                data=> {
                    console.log(data);
                    printReplyList(data.dtoList);
                    printPaging(data.pageRequestDTO);
                }
            )
            .catch(e=>{console.log(e);});   //try-catch와 같아
    }

    printReplyArea(1, 10);

    function printReplyList(dtoList) {
        let replyLi = "";
        if (dtoList && dtoList.length > 0) {
            for (const dto of dtoList) {
                // reDate = (dto.regDate != null && dto.regDate != "" && dto.regDate != undefined && dto.regDate != "undefined" ? dto.regDate.toString().substring(0, 10) : "-");
                regDate = dto.regDate;
                replyLi += ` <div class="product__details__tab__desc border-bottom mt-2">
                              <h6 class="mb-2">${dto.memberId} <button class="badge progress-bar-success replyDelete " style="background-color: #0a53be" onclick="replyDeleteOK(${dto.boardReplyIdx})">X</button></h6>
                              <p>${dto.comment} </p>
                              <p>${dto.regDate}</p>
                               </div>`;

            }

        } else {
            replyLi += `<li class="list-group-item d-flex replyItem"> <span class="col-12">등록된 댓글이 없습니다.</span></li>`;
        }
        replyList.innerHTML = replyLi;
    }

    function printPaging(data) {
        console.log("printPaging >>> " , data);

        let pagePrevLi = "";
        let pageNextLi = "";
        let pageLiList = "";
        let pageArea = "";

        if (data.prev_page_flag) {
            pagePrevLi += `<li class="page-item"><a class="page-link" data-page="${data.page_block_start-10}"onclick="printReplyArea(${data.page_block_start - 10}, 10)">PREV</a></li>`
        }
        else {
            pagePrevLi += `<li class="page-item"><a class="page-link" data-page="${data.page_block_start-10}"  >PREV</a></li>`
        }

        for (let i=data.page_block_start; i<=data.page_block_end; i++) {
            if (data.page == i) {
                pageLiList += `<li class="page-item active"> <a class="page-link" data-page="${i}" >${i}</a> </li>`
            } else {
                pageLiList += `<li class="page-item"> <a class="page-link" data-page="${i}" onclick="printReplyArea(${i}, 10)">${i}</a> </li>`
            }
        }

        if (data.next_page_flag) {
            pageNextLi += `<li class="page-item"><a class="page-link" data-page="${data.page_block_end+1}" onclick="printReplyArea(${data.page_block_end + 1}, 10)">NEXT</a></li>`
        }
        else {
            pageNextLi += `<li class="page-item"><a class="page-link" data-page="${data.page_block_start+1}"  >NEXT</a></li>`
        }

        pageArea = pagePrevLi + pageLiList + pageNextLi;
        replyPaging.innerHTML = pageArea;
    }

    function replyDeleteOK(idx) {
        replyDelete(idx);
        printReplyArea(1, 10, "true");     //맨 마지막 페이지에 있는 하나를 삭제했을 때 페이징 오류가 생기는거 방지하기 위해 1페이지로 이동!
    }
</script>

</body>
</html>